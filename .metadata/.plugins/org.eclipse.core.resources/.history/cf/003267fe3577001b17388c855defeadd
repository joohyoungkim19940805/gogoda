package g.g.d.com.mem.controller;

import java.io.IOException;
import java.util.List;
import javax.servlet.http.HttpServletRequest;
import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import g.g.d.com.mem.common.ChabunService;
import g.g.d.com.mem.common.ChabunUtil;
import g.g.d.com.mem.common.MailSend;
import g.g.d.com.mem.service.MemberService;
import g.g.d.com.mem.vo.MemberVO;

// 현 클래스를 controller bean 에 등록
@Controller
@RequestMapping(value="mem")
public class MemberController {
	Logger logger = Logger.getLogger(MemberController.class);
	
	// MemberService 객체를 스프링에서 생성하여 주입
	//@Inject
	//private MemberService memberService;
	
	@Autowired(required=false)
	private MemberService memberService;
	
	@Autowired(required=false)
	private ChabunService chabunService;
	
	// 회원 가입 페이지로 이동
	@RequestMapping(value="registerForm", method = RequestMethod.GET)
	public String member() {
		logger.info("registerForm 호출 성공 >>>");
		return "member/registerForm";
	}

	// 회원 등록 처리 후 회원 목록으로 리다이렉트
	// @ModelAttribute 에 폼에서 입력한 데이터가 저장
	
	// 폼에서 입력한 데이터를 받아오는 3가지 방법
	// public String memberInsert(HttpServlet request) {
	// public String memberInsert(String mid, String mpw) {
	// public String memberInsert(@ModelAttribute MemberVO mvo) {
	@RequestMapping(value="memberInsert", method = {RequestMethod.GET ,RequestMethod.POST})
	public String memberInsert(@ModelAttribute MemberVO mvo, HttpServletRequest request) throws IllegalStateException, IOException {
		logger.info("memberInsert 호출 성공");

		String mnum = ChabunUtil.getMemChabun("N", chabunService.getChabun().getMnum());
		
		mvo.setMnum(mnum);
		logger.info("mname>>>"+mvo.getMname());
		logger.info("mname>>>"+mvo.getMaddr());
		logger.info("mname>>>"+mvo.getMaddrdetail());
		
		
		
		int result = 0;
		String url = "";
		// 테이블에 레코드 입력		
		result = memberService.memberInsert(mvo);
		
		if (result == 0) {
				System.out.println("");
			 	url = "registerForm.ggd";
				return "../index.jsp";
		}else {
			return "redirect:memberSelectAll.ggd";
		}
		
	}
	// '/' 유무의 차이
	// /member/list.do : 루트  디렉토리를 기준
	// member/list.do : 현재 디렉토리를 기준
	// member_list.jsp 로 리다이렉트
	
	// 회원 정보 수정
	@RequestMapping(value="memberUpdate", method = RequestMethod.POST)
	public String memberUpdate(@ModelAttribute MemberVO mvo,HttpServletRequest request) throws IllegalStateException, IOException {
		logger.info("memberUpdate 호출 성공");
		int result = 0;
		String url = "";
		
		result = memberService.memberUpdate(mvo);
		logger.info("memberUpdate 호출 성공 = "+result);	
		if (result == 1) {
			url = "memberSelectAll.ggd"; // 수정 후 상세 페이지로 이동
		}		
		return "redirect:" + url;		
	}
/*
	@RequestMapping(value="memberUpdate")
	public String memberUpdate(@ModelAttribute MemberVO mvo, Model model) {
		// 비밀번호 체크
		boolean result = memberService.checkPw(vo.getMid(), vo.getMpw()); // checkPw 필드
		// 비밀번호가 맞다면, 수정 처리 후, 전체 회원 목록으로 리다이렉트
		if (result){
			memberService.memberUpdate(mid);
			return "redirect:member/memberSelectAll.do";
		}else{ // 비밀번호가 일치하지 않는다면
			// 가입일자, 수정일자 저장
			MemberVO mvo2 = memberService.memberSelect(vo.getMid());
			vo.setMupdatedate(vo2.getMupdatedate());
			model.addAtrribute("message", "비밀번호 불일치");
			model.addAtrribute("mvo", vo);
			return "member/memberSelectAll"; //
		}	
	}
	
 */
	// 회원 정보 삭제
	@RequestMapping(value="memberDelete")
	public String memberDelete(@ModelAttribute MemberVO mvo,HttpServletRequest request) throws IllegalStateException, IOException {
		logger.info("memberDelete 호출 성공");

		// 아래 변수에는 삭제 성공에 대한 상태값 담습니다. (1 or 0)
		int result = 0;
		String url = "";
		
		result = memberService.memberDelete(mvo);
		
		if (result == 1) {
			url="registerForm.ggd";
		}		
		return "redirect:" + url;		
	}
/*	
	@RequestMapping(value="memberDelete")
	public String memberDelete(@RequestParam String mid, @RequestParam String mpw, Model model){
		// 비밀번호 체크
		boolean result = memberService.checkPw(mid, mpw); // checkPw 필드
		// 비밀번호가 맞다면, 삭제 처리 후, 전체 회원 목록으로 리다이렉트
		if (result){
			memberService.memberDelete(mid);
			return "redirect:member/memberSelectAll.do";
		}else{
			model.addAtrribute("message", "비밀번호 불일치");
			model.addAtrribute("mvo", memberService.memberSelect(mid));
			return "member/memberSelectAll"; //
		}	
	}
	
*/	
	// 회원 정보 상세조회
	@RequestMapping(value="memberSelect", method = RequestMethod.GET)
//	public String memberSelect(@RequestParaam String mid, Model model) {
	public String memberSelect(@ModelAttribute MemberVO mvo, Model model) {
		logger.info("memberSelect 호출 성공");

		logger.info("Mnum = " + mvo.getMnum());
		String mnum=mvo.getMnum();
		MemberVO detail = new MemberVO();
		detail = memberService.memberSelect(mvo);
		// 회원 정보를 model 에 저장
		//detail = memberService.memberSelect(mid);
		if (detail !=null && (!detail.equals(""))) {
			model.addAttribute("detail", detail);
			model.addAttribute("mnum", mnum);
		}
		//System.out.println("클릭한 ID 확인 : " + mid);
		//logger.info("클릭한 아이디 : " + mid);
		// memberSelect.jsp 로 포워드
		return "member/memberSelect"; 
	}
	
	// 회원 목록 조회
	@RequestMapping(value="/memberSelectAll", method = RequestMethod.GET)
	public String memberSelectAll(@ModelAttribute MemberVO mvo, Model model) {
		logger.info("memberSelectAll 호출 성공");

		List<MemberVO> listAll = memberService.memberSelectAll(mvo);
		int nCnt = listAll.size();
		logger.info("MemberController memberSelectAll nCnt >>> : " + nCnt);
		
		if (nCnt > 0) {
			model.addAttribute("listAll", listAll);		
		}
		return "member/memberSelectAll";	
	}
	
	// id check 버튼
	@RequestMapping(value="idCheck", method = RequestMethod.POST)
	@ResponseBody
	public String idCheck(MemberVO mvo) {
		logger.info("MemberController idCheck >>> : " );
		logger.info("MemberController idCheck mvo.getMid() >>> : " +  mvo.getMid());
		
		List<MemberVO> listAll = memberService.idCheck(mvo);
		if (listAll.size() == 0) {
			return "ID_GOOD";
		}else {
			return "";
		}
		
	}	
    
	// 이메일 인증 
//	@RequestMapping( value = "/member/auth.do" , method=RequestMethod.POST )
//    public ModelAndView mailSending(HttpServletRequest request, String memail, HttpServletResponse response_email) throws IOException {

	@RequestMapping(value="/mailCheck", method=RequestMethod.GET)
	@ResponseBody
	public String mailCheckGET(HttpServletRequest request, String mail, String key) throws Exception{
		
		// 뷰(View)로부터 넘어온 데이터 확인 
		logger.info("이메일 데이터 전송 확인");
		logger.info("이메일 : " + mail);
		logger.info("mail" + request.getParameter("mail"));
		logger.info("이메일 : " + request.getParameter("key"));
		new MailSend().MailSet(key, mail);
		
		/*
		// 인증번호(난수) 생성 
		Random random = new Random();
		int checkNum = random.nextInt(888888) + 111111;
		logger.info("인증번호 " + checkNum);
		
		// 이메일 보내기
		String setFrom = "solideo226@gmail.com";
		String toMail = mail;
		String title = "회원가입 인증 이메일 입니다.";
		String content = 
						 "홈페이지를 방문해주셔서 감사합니다." +
						 "<br><br>" + 
						 "인증 번호는 " + checkNum + "입니다." + 
						 "<br>" + 
						 "해당 인증번호를 인증번호 확인란에 기입하여 주세요.";		
		
		// 이메일 전송을 위한 코드 삽입
		try {
			MimeMessage message = mailSender.createMimeMessage();
			MimeMessageHelper helper = new MimeMessageHelper(message, true, "utf-8");
				helper.setFrom(setFrom);
				helper.setTo(toMail);
				helper.setSubject(title);
				helper.setText(content,true);
				mailSender.send(message);			
		}catch(Exception e) {
			e.printStackTrace();
		}		
		// 인증번호 회원가입 페이지로 전송
		// ajax를 통한 요청으로 인해 뷰로 다시 반환할 때 데이터 타입은 String 타입만 가능
		 * */
		//String num = Integer.toString(authnum);
		//response.setHeader("Content-Type", "text/html;charset=utf-8");
		
		return "member/registerForm";
		
	}
	
}
